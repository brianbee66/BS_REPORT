{
	"name": "df_load_sql_debtordemographic",
	"properties": {
		"folder": {
			"name": "Load/BSS"
		},
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"linkedService": {
						"referenceName": "ls_reporting_adls",
						"type": "LinkedServiceReference"
					},
					"name": "sourceODS"
				},
				{
					"dataset": {
						"referenceName": "ds_reporting_lookup_mssql",
						"type": "DatasetReference"
					},
					"name": "sourceSQLLookupDebtor"
				}
			],
			"sinks": [
				{
					"dataset": {
						"referenceName": "ds_reporting_mssql",
						"type": "DatasetReference"
					},
					"name": "sinkSQL"
				}
			],
			"transformations": [
				{
					"name": "SelectODS"
				},
				{
					"name": "dcolSQL"
				},
				{
					"name": "JoinSQLDebtor"
				},
				{
					"name": "AlterRowSQL"
				},
				{
					"name": "SelectSQLDebtor"
				},
				{
					"name": "FilterODS"
				}
			],
			"script": "parameters{\n\tpartdistFrom as string\n}\nsource(output(\n\t\tntt_breathingspacedebtor_inss_inssaddressid as string,\n\t\tntt_breathingspacedebtorid as string,\n\t\tstrNTTBreathingSpaceDebtorInssInssAddressId as string,\n\t\tstrNTTBreathingSpaceDebtorId as string,\n\t\tmodifiedon as string,\n\t\tinss_inssaddressid as string,\n\t\tcreatedon as string,\n\t\tintBatchId as integer,\n\t\tpartdist as date,\n\t\tblIsValid as boolean,\n\t\tstrInssInssAddressId as string,\n\t\ttsModifiedOn as timestamp,\n\t\ttsCreatedOn as timestamp,\n\t\tblIsTruncate as boolean,\n\t\tcty as string,\n\t\tlaua as string,\n\t\tctry as string,\n\t\trgn as string,\n\t\tpcon as string,\n\t\tlat as string,\n\t\tlong as string,\n\t\tcountry as string,\n\t\tcounty as string,\n\t\tregion as string,\n\t\tlocalauthority as string,\n\t\tparliamentaryconstituency as string,\n\t\ttsINSSDateFrom as timestamp,\n\t\ttsINSSDateTo as timestamp\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: true,\n\tformat: 'delta',\n\tfileSystem: 'curation',\n\tfolderPath: 'ods/bss/dynamics/debtors/debtordemographic') ~> sourceODS\nsource(output(\n\t\tbs_debtor_pk_skey as integer,\n\t\tntt_debtoreligibilitystatustypeid as string,\n\t\tntt_breathingspacedebtorid as string,\n\t\tntt_addresswithheld as boolean,\n\t\tntt_name as string,\n\t\tdebtor_age_band as string,\n\t\tcreatedon as timestamp,\n\t\tmodifiedon as timestamp,\n\t\tisValid as boolean,\n\t\tisTruncate as boolean,\n\t\tbatch_id as integer\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tformat: 'table') ~> sourceSQLLookupDebtor\nJoinSQLDebtor select(mapColumn(\n\t\tntt_breathingspacedebtor_inss_inssaddressid = strNTTBreathingSpaceDebtorInssInssAddressId,\n\t\tbatch_id = intBatchId,\n\t\tisValid = blIsValid,\n\t\tisTruncate = blIsTruncate,\n\t\tlatitude = lat,\n\t\tlongitude = long,\n\t\tcountry,\n\t\tcounty,\n\t\tregion,\n\t\tla_ua = localauthority,\n\t\twestminster_parliamentary_constituency = parliamentaryconstituency,\n\t\tdatefrom = tsINSSDateFrom,\n\t\tdateto = tsINSSDateTo,\n\t\tbs_debtor_fk = bs_debtor_pk_skey,\n\t\tmodifiedon = tsModifiedOn,\n\t\tcreatedon = tsCreatedOn\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectODS\nSelectODS derive(country = coalesce(country, 'unknown'),\n\t\tcounty = coalesce(county, 'unknown'),\n\t\tla_ua = coalesce(la_ua, 'unknown'),\n\t\twestminster_parliamentary_constituency = coalesce(westminster_parliamentary_constituency, 'unknown'),\n\t\tlatitude = coalesce(latitude, 'unknown'),\n\t\tlongitude = coalesce(longitude, 'unknown'),\n\t\tregion = coalesce(region, 'unknwon')) ~> dcolSQL\nFilterODS, SelectSQLDebtor join(strNTTBreathingSpaceDebtorId == SelectSQLDebtor@ntt_breathingspacedebtorid,\n\tjoinType:'inner',\n\tbroadcast: 'auto')~> JoinSQLDebtor\ndcolSQL alterRow(upsertIf(true())) ~> AlterRowSQL\nsourceSQLLookupDebtor select(mapColumn(\n\t\tbs_debtor_pk_skey,\n\t\tntt_breathingspacedebtorid\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectSQLDebtor\nsourceODS filter(partdist >= toDate($partdistFrom)) ~> FilterODS\nAlterRowSQL sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:false,\n\tupsertable:true,\n\tkeys:['ntt_breathingspacedebtor_inss_inssaddressid'],\n\tformat: 'table',\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\terrorHandlingOption: 'stopOnFirstError') ~> sinkSQL"
		}
	}
}